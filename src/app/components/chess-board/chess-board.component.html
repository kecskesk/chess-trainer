<div class="trainer-layout">
  <div class="info-hover" [attr.aria-label]="uiText.infoOverlay.ariaLabel" [class.info-hover--open]="isInfoOverlayOpen">
    <button class="info-hover__trigger"
            type="button"
            [attr.aria-label]="uiText.infoOverlay.triggerAriaLabel"
            [attr.aria-expanded]="isInfoOverlayOpen">‚ìò</button>
    <div class="info-hover__panel" role="note">
      <div class="info-hover__title">{{uiText.infoOverlay.title}}</div>
      <ul>
        <li *ngFor="let item of uiText.infoOverlay.items">{{item}}</li>
      </ul>
    </div>
  </div>
  <div class="ambient-math" [ngClass]="getAmbientThemeClass()" [ngStyle]="ambientStyle" aria-hidden="true"></div>
  <section class="board-panel">
    <div class="board-stack">
      <div class="outer-container board-shell" [class.board-shell--flipped]="isBoardFlipped">
        <div class="container" #chessField>
          <div #row class="field-row" *ngFor="let rowX of chessBoardStateService.field; index as idxX">
            <div class="field-cell" *ngFor="let cellY of rowX; index as idxY">
              <div class="piece-box">
                <div class="square"
                     cdkDropList
                     cdkDropListOrientation="horizontal"
                      [cdkDropListEnterPredicate]="canDropPredicate"
                     id="field{{idxX}}{{idxY}}"
                     [ngClass]="getSquareHighlightClass(idxX, idxY)"
                     [cdkDropListData]="cellY"
                     [cdkDropListConnectedTo]="dropLists"
                     (cdkDropListEntered)="onDropListEntered($event)"
                     (cdkDropListDropped)="onDrop($event)"
                     [class.white-square]="isWhiteSquare(idxX, idxY)"
                     [class.black-square]="!isWhiteSquare(idxX, idxY)">
                  <div class="drag-box" (mousedown)="onSquarePointerDown(cellY)">
                    <app-chess-piece [piece]="cellY[0]"
                                     *ngIf="cellY && cellY[0]"
                                     cdkDrag
                                     [cdkDragData]="cellY[0]"
                                     [cdkDragDisabled]="chessBoardStateService.boardHelper.gameOver || !cellY || !cellY[0] || cellY[0].color !== chessBoardStateService.boardHelper.colorTurn"
                                     (cdkDragStarted)="onDragStarted()"
                                     (cdkDragEnded)="onDragEnded()"></app-chess-piece>
                  </div>
                  <div class="notation">{{translateFieldNames(idxX, idxY)}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="arrowPointer" *ngFor="let arrow of chessBoardStateService.arrows; index as arrowIdx"
             [style.top]="arrow.top" [style.left]="arrow.left" [style.color]="arrow.color"
             [style.width]="arrow.length"
             [style.--arrow-thickness]="arrow.thickness"
             [style.transform]="'translate(-50%, -50%) rotate(' + arrow.rotate + ')'">
          <span class="arrow-shaft"></span>
          <span class="arrow-head"></span>
        </div>
      </div>

      <details class="position-key-panel"
               *ngIf="chessBoardStateService.boardHelper"
               [open]="isDebugPanelOpen"
               (toggle)="onDebugPanelToggle($event)">
        <summary>{{uiText.debugPanel.summary}}</summary>
        <div class="position-key-value" *ngIf="chessBoardStateService.boardHelper.debugText"
             [textContent]="chessBoardStateService.boardHelper.debugText"></div>
        <div class="position-key-value">{{getDebugPositionKey()}}</div>
      </details>
    </div>
  </section>

  <section class="sidebar-panel">
    <div class="clock-card panel-card panel-card--wide">
      <div class="clock-card-header">
        <h3 class="section-title">{{uiText.clock.sectionTitle}}</h3>
        <div class="clock-brand" [attr.aria-label]="uiText.clock.brandAriaLabel">
          <img class="clock-brand__logo" src="horse.svg" [attr.alt]="uiText.clock.logoAlt" />
          <span class="clock-brand__title">{{uiText.app.brandTitle}}</span>
        </div>
      </div>
      <div class="clock-layout">
        <div class="clock-stack">
          <div class="clock-display"
               [class.clock-display--active]="isClockActive(chessColors.Black)"
               [class.clock-display--low]="isClockLow(chessColors.Black)">
            <div class="clock-meta">
              <span class="clock-player">{{uiText.clock.black}}</span>
              <span class="clock-status" [class.clock-status--running]="isClockActive(chessColors.Black)"></span>
            </div>
            <span class="clock-time">{{formatClock(blackClockMs)}}</span>
          </div>
          <div class="clock-display"
               [class.clock-display--active]="isClockActive(chessColors.White)"
               [class.clock-display--low]="isClockLow(chessColors.White)">
            <div class="clock-meta">
              <span class="clock-player">{{uiText.clock.white}}</span>
              <span class="clock-status" [class.clock-status--running]="isClockActive(chessColors.White)"></span>
            </div>
            <span class="clock-time">{{formatClock(whiteClockMs)}}</span>
          </div>
        </div>

        <div class="clock-controls">
          <div class="clock-controls-grid">
            <button class="time-btn"
              [disabled]="clockStarted"
              [class.time-btn--selected]="selectedClockPresetLabel === '1+0'"
              (click)="applyTimeControl(1, 0, '1+0')">1+0</button>
            <button class="time-btn"
              [disabled]="clockStarted"
              [class.time-btn--selected]="selectedClockPresetLabel === '3+2'"
              (click)="applyTimeControl(3, 2, '3+2')">3+2</button>
            <button class="action-btn action-btn--large" (click)="startOrPauseClock()">{{getClockButtonLabel()}}</button>
            <button class="time-btn"
              [disabled]="clockStarted"
              [class.time-btn--selected]="selectedClockPresetLabel === '5+0'"
              (click)="applyTimeControl(5, 0, '5+0')">5+0</button>
            <button class="time-btn"
              [disabled]="clockStarted"
              [class.time-btn--selected]="selectedClockPresetLabel === '10+0'"
              (click)="applyTimeControl(10, 0, '10+0')">10+0</button>
            <button class="action-btn action-btn--secondary action-btn--large" (click)="resetClock()">{{uiText.clock.reset}}</button>
          </div>
        </div>
      </div>
    </div>

    <div class="status-card panel-card panel-card--wide">
      <h3 class="section-title">
        {{getStatusTitle()}}
      </h3>
      <div class="icon-actions-row icon-actions-row--compact icon-actions-row--status">
        <button class="icon-action-btn"
          (click)="showPossibleMoves(chessBoardStateService.boardHelper.colorTurn)"
          [attr.title]="uiText.status.showPossibleMovesTitle"
          [attr.aria-label]="uiText.status.showPossibleMovesAriaLabel">
          <span class="icon-action-btn__icon">üëÅ</span>
          <span class="icon-action-btn__text">{{uiText.status.showMoves}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--secondary"
          (click)="showPossibleMoves(null)"
          [attr.title]="uiText.status.clearHighlightsTitle"
          [attr.aria-label]="uiText.status.clearHighlightsAriaLabel">
          <span class="icon-action-btn__icon">‚å´</span>
          <span class="icon-action-btn__text">{{uiText.status.clearHighlights}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--secondary status-action-new-game"
          *ngIf="pendingDrawOfferBy === null"
          (click)="startNewGame()"
          [attr.title]="uiText.status.startNewGameTitle"
          [attr.aria-label]="uiText.status.startNewGameAriaLabel">
          <span class="icon-action-btn__icon">‚Üª</span>
          <span class="icon-action-btn__text">{{uiText.status.newGame}}</span>
        </button>
        <button class="icon-action-btn"
          *ngIf="canOfferDraw()"
          (click)="offerDraw()"
          [attr.title]="uiText.status.offerDrawTitle"
          [attr.aria-label]="uiText.status.offerDrawAriaLabel">
          <span class="icon-action-btn__icon">ü§ù</span>
          <span class="icon-action-btn__text">{{uiText.status.offerDraw}}</span>
        </button>
        <button class="icon-action-btn"
          *ngIf="canRespondToDrawOffer()"
          (click)="acceptDrawOffer()"
          [attr.title]="uiText.status.acceptDrawTitle"
          [attr.aria-label]="uiText.status.acceptDrawAriaLabel">
          <span class="icon-action-btn__icon">‚úî</span>
          <span class="icon-action-btn__text">{{uiText.status.acceptDraw}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--secondary"
          *ngIf="canRespondToDrawOffer()"
          (click)="declineDrawOffer()"
          [attr.title]="uiText.status.declineDrawTitle"
          [attr.aria-label]="uiText.status.declineDrawAriaLabel">
          <span class="icon-action-btn__icon">‚úñ</span>
          <span class="icon-action-btn__text">{{uiText.status.declineDraw}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--secondary"
          *ngIf="canClaimDraw()"
          (click)="claimDraw()"
          [attr.title]="uiText.status.claimDrawTitle"
          [attr.aria-label]="uiText.status.claimDrawAriaLabel">
          <span class="icon-action-btn__icon">‚öñ</span>
          <span class="icon-action-btn__text">{{uiText.status.claimDraw}}</span>
        </button>
      </div>
      <div class="icon-actions-row icon-actions-row--resign" *ngIf="clockRunning">
        <button class="icon-action-btn icon-action-btn--danger"
                [disabled]="!canResign(chessColors.White)"
                (click)="openResignConfirm(chessColors.White)"
                [attr.title]="uiText.status.whiteResignTitle"
                [attr.aria-label]="uiText.status.whiteResignAriaLabel">
          <span class="icon-action-btn__icon">‚ôî</span>
          <span class="icon-action-btn__text">{{uiText.status.white}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--danger"
                [disabled]="!canResign(chessColors.Black)"
                (click)="openResignConfirm(chessColors.Black)"
                [attr.title]="uiText.status.blackResignTitle"
                [attr.aria-label]="uiText.status.blackResignAriaLabel">
          <span class="icon-action-btn__icon">‚ôö</span>
          <span class="icon-action-btn__text">{{uiText.status.black}}</span>
        </button>
      </div>
    </div>

    <div class="status-card panel-card panel-card--wide" *ngIf="resignConfirmColor !== null" role="dialog" aria-modal="false" [attr.aria-label]="uiText.resignConfirm.dialogAriaLabel">
      <h3 class="section-title">{{getResignConfirmTitle()}}</h3>
      <div class="icon-actions-row icon-actions-row--compact">
        <button class="icon-action-btn icon-action-btn--secondary" (click)="cancelResignConfirm()" [attr.title]="uiText.resignConfirm.cancelTitle" [attr.aria-label]="uiText.resignConfirm.cancelAriaLabel">
          <span class="icon-action-btn__icon">‚úñ</span>
          <span class="icon-action-btn__text">{{uiText.resignConfirm.cancel}}</span>
        </button>
        <button class="icon-action-btn icon-action-btn--danger" (click)="confirmResign()" [attr.title]="uiText.resignConfirm.confirmTitle" [attr.aria-label]="uiText.resignConfirm.confirmAriaLabel">
          <span class="icon-action-btn__icon">‚öë</span>
          <span class="icon-action-btn__text">{{uiText.resignConfirm.confirm}}</span>
        </button>
      </div>
    </div>

    <div class="tool-card panel-card panel-card--wide" *ngIf="chessBoardStateService.boardHelper.canPromote !== null">
      <h3 class="section-title">{{uiText.promotion.sectionTitle}}</h3>
      <div class="icon-actions-row promote-row">
        <button class="icon-action-btn" (click)="promotePiece('rook')" [attr.title]="uiText.promotion.promoteToRookTitle" [attr.aria-label]="uiText.promotion.promoteToRookAriaLabel">
          <span class="icon-action-btn__icon">‚ôñ</span>
          <span class="icon-action-btn__text">{{uiText.promotion.rook}}</span>
        </button>
        <button class="icon-action-btn" (click)="promotePiece('bishop')" [attr.title]="uiText.promotion.promoteToBishopTitle" [attr.aria-label]="uiText.promotion.promoteToBishopAriaLabel">
          <span class="icon-action-btn__icon">‚ôó</span>
          <span class="icon-action-btn__text">{{uiText.promotion.bishop}}</span>
        </button>
        <button class="icon-action-btn" (click)="promotePiece('knight')" [attr.title]="uiText.promotion.promoteToKnightTitle" [attr.aria-label]="uiText.promotion.promoteToKnightAriaLabel">
          <span class="icon-action-btn__icon">‚ôò</span>
          <span class="icon-action-btn__text">{{uiText.promotion.knight}}</span>
        </button>
        <button class="icon-action-btn" (click)="promotePiece('queen')" [attr.title]="uiText.promotion.promoteToQueenTitle" [attr.aria-label]="uiText.promotion.promoteToQueenAriaLabel">
          <span class="icon-action-btn__icon">‚ôï</span>
          <span class="icon-action-btn__text">{{uiText.promotion.queen}}</span>
        </button>
      </div>
    </div>

    <div class="tool-card panel-card">
      <h3 class="section-title">{{uiText.magicToolkit.sectionTitle}}</h3>
      <div class="icon-actions-row">
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='threats-mine'"
                (click)="showThreats()" [attr.title]="uiText.magicToolkit.myThreatsTitle" [attr.aria-label]="uiText.magicToolkit.myThreatsAriaLabel">
          <span class="icon-action-btn__icon">‚öî</span>
          <span class="icon-action-btn__text">{{uiText.magicToolkit.mine}}</span>
        </button>
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='protected-mine'"
                (click)="showProtected()" [attr.title]="uiText.magicToolkit.myProtectedTitle" [attr.aria-label]="uiText.magicToolkit.myProtectedAriaLabel">
          <span class="icon-action-btn__icon">üõ°</span>
          <span class="icon-action-btn__text">{{uiText.magicToolkit.safe}}</span>
        </button>
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='threats-enemy'"
                (click)="showThreats(true)" [attr.title]="uiText.magicToolkit.enemyThreatsTitle" [attr.aria-label]="uiText.magicToolkit.enemyThreatsAriaLabel">
          <span class="icon-action-btn__icon">‚ò†</span>
          <span class="icon-action-btn__text">{{uiText.magicToolkit.enemy}}</span>
        </button>
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='protected-enemy'"
                (click)="showProtected(true)" [attr.title]="uiText.magicToolkit.enemyProtectedTitle" [attr.aria-label]="uiText.magicToolkit.enemyProtectedAriaLabel">
          <span class="icon-action-btn__icon">‚õ®</span>
          <span class="icon-action-btn__text">{{uiText.magicToolkit.guarded}}</span>
        </button>
      </div>
    </div>

    <div class="tool-card panel-card">
      <h3 class="section-title">{{uiText.magicerToolkit.sectionTitle}}</h3>
      <div class="icon-actions-row icon-actions-row--compact">
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='hanging-mine'"
                (click)="showHangingPieces()" [attr.title]="uiText.magicerToolkit.myHangingTitle" [attr.aria-label]="uiText.magicerToolkit.myHangingAriaLabel">
          <span class="icon-action-btn__icon">‚ö†</span>
          <span class="icon-action-btn__text">{{uiText.magicerToolkit.blunder}}</span>
        </button>
        <button class="icon-action-btn"
                [class.time-btn--selected]="activeTool==='hanging-enemy'"
                (click)="showHangingPieces(true)" [attr.title]="uiText.magicerToolkit.enemyHangingTitle" [attr.aria-label]="uiText.magicerToolkit.enemyHangingAriaLabel">
          <span class="icon-action-btn__icon">üéØ</span>
          <span class="icon-action-btn__text">{{uiText.magicerToolkit.target}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled" (click)="showForkIdeasMock()" [attr.title]="uiText.magicerToolkit.forkIdeasTitle" [attr.aria-label]="uiText.magicerToolkit.forkIdeasAriaLabel">
          <span class="icon-action-btn__icon">‚ëÇ</span>
          <span class="icon-action-btn__text">{{uiText.magicerToolkit.fork}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled" (click)="showPinIdeasMock()" [attr.title]="uiText.magicerToolkit.pinIdeasTitle" [attr.aria-label]="uiText.magicerToolkit.pinIdeasAriaLabel">
          <span class="icon-action-btn__icon">üìå</span>
          <span class="icon-action-btn__text">{{uiText.magicerToolkit.pin}}</span>
        </button>
      </div>
    </div>

    <div class="tool-card panel-card">
      <h3 class="section-title">{{uiText.gameTools.sectionTitle}}</h3>
      <div class="icon-actions-row icon-actions-row--compact">
        <button class="icon-action-btn" (click)="toggleBoardFlip()"
                [class.time-btn--selected]="isBoardFlipped"
                [attr.title]="uiText.gameTools.flipBoardTitle" [attr.aria-label]="uiText.gameTools.flipBoardAriaLabel">
          <span class="icon-action-btn__icon">‚áÖ</span>
          <span class="icon-action-btn__text">{{uiText.gameTools.flip}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled" (click)="exportPgnMock()" [attr.title]="uiText.gameTools.exportPgnTitle" [attr.aria-label]="uiText.gameTools.exportPgnAriaLabel">
          <span class="icon-action-btn__icon">‚≠≥</span>
          <span class="icon-action-btn__text">{{uiText.gameTools.pgn}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled" (click)="exportBoardImageMock()" [attr.title]="uiText.gameTools.exportImageTitle" [attr.aria-label]="uiText.gameTools.exportImageAriaLabel">
          <span class="icon-action-btn__icon">üñº</span>
          <span class="icon-action-btn__text">{{uiText.gameTools.image}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled" (click)="exportFenMock()" [attr.title]="uiText.gameTools.exportFenTitle" [attr.aria-label]="uiText.gameTools.exportFenAriaLabel">
          <span class="icon-action-btn__icon">‚åò</span>
          <span class="icon-action-btn__text">{{uiText.gameTools.fen}}</span>
        </button>
      </div>
      <div class="mock-export-text" *ngIf="mockExportMessage">{{mockExportMessage}}</div>
    </div>

    <div class="tool-card panel-card">
      <h3 class="section-title">{{uiText.recognition.sectionTitle}}</h3>
      <div class="recognition-line"><strong>{{uiText.recognition.openingLabel}}:</strong> {{getMockOpeningRecognition()}}</div>
      <div class="recognition-line"><strong>{{uiText.recognition.endgameLabel}}:</strong> {{getMockEndgameRecognition()}}</div>
      <div class="recognition-line recognition-line--suggestions">
        <strong>{{uiText.recognition.suggestedLabel}}:</strong>
        <span class="suggested-move"
              [ngClass]="getSuggestedMoveClass(move)"
            (mouseenter)="previewSuggestedMoveArrows(move)"
            (mouseleave)="clearSuggestedMoveArrows()"
              *ngFor="let move of getMockSuggestedMoves()">{{move}}</span>
      </div>
    </div>

    <div class="history-card panel-card">
      <h3 class="section-title">{{uiText.history.sectionTitle}}</h3>
      <div class="icon-actions-row icon-actions-row--compact history-controls">
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled || !canUndoMoveMock()" (click)="undoMoveMock()" [attr.title]="uiText.history.undoTitle" [attr.aria-label]="uiText.history.undoAriaLabel">
          <span class="icon-action-btn__icon">‚Ü∂</span>
          <span class="icon-action-btn__text">{{uiText.history.undo}}</span>
        </button>
        <button class="icon-action-btn" [disabled]="areMockControlsDisabled || !canRedoMoveMock()" (click)="redoMoveMock()" [attr.title]="uiText.history.redoTitle" [attr.aria-label]="uiText.history.redoAriaLabel">
          <span class="icon-action-btn__icon">‚Ü∑</span>
          <span class="icon-action-btn__text">{{uiText.history.redo}}</span>
        </button>
      </div>
      <div class="history-log">
        <div class="history-entry"
             [class.history-entry--white]="histIdx % 2 === 0"
             [class.history-entry--black]="histIdx % 2 === 1"
             *ngFor="let histItem of getVisibleHistory(); index as histIdx">
          <span class="history-move" [class.history-move--black]="histIdx % 2 === 1">
            <span *ngIf="histIdx % 2 === 0">{{(histIdx / 2) + 1}}. </span>
            {{histItem}}
          </span>
          <span class="history-eval">{{uiText.history.sfPrefix}} {{getMockEvaluationForMove(histIdx)}}</span>
        </div>
      </div>
    </div>

    <div class="tool-card panel-card cct-card">
      <h3 class="section-title">{{uiText.cct.sectionTitle}}</h3>
      <div class="cct-row cct-row--capture" [attr.title]="uiText.cct.capturesRowTitle">
        <span class="cct-row__icon" [attr.title]="uiText.cct.capturesIconTitle">‚úï</span>
        <ng-container *ngIf="getCctRecommendations(cctCategory.Captures) as captureRecs">
              <span class="cct-step"
                *ngFor="let rec of captureRecs"
                [title]="rec.tooltip"
                (mouseenter)="previewSuggestedMoveArrows(rec.move)"
                (mouseleave)="clearSuggestedMoveArrows()">{{rec.move}}</span>
          <span class="cct-empty" *ngIf="captureRecs.length < 1" [attr.title]="uiText.cct.noCapturesTitle">‚Äî</span>
        </ng-container>
      </div>
      <div class="cct-row cct-row--check" [attr.title]="uiText.cct.checksRowTitle">
        <span class="cct-row__icon" [attr.title]="uiText.cct.checksIconTitle">‚ôî</span>
        <ng-container *ngIf="getCctRecommendations(cctCategory.Checks) as checkRecs">
              <span class="cct-step"
                *ngFor="let rec of checkRecs"
                [title]="rec.tooltip"
                (mouseenter)="previewSuggestedMoveArrows(rec.move)"
                (mouseleave)="clearSuggestedMoveArrows()">{{rec.move}}</span>
          <span class="cct-empty" *ngIf="checkRecs.length < 1" [attr.title]="uiText.cct.noChecksTitle">‚Äî</span>
        </ng-container>
      </div>
      <div class="cct-row cct-row--threat" [attr.title]="uiText.cct.threatsRowTitle">
        <span class="cct-row__icon" [attr.title]="uiText.cct.threatsIconTitle">‚ö†</span>
        <ng-container *ngIf="getCctRecommendations(cctCategory.Threats) as threatRecs">
              <span class="cct-step"
                *ngFor="let rec of threatRecs"
                [title]="rec.tooltip"
                (mouseenter)="previewSuggestedMoveArrows(rec.move)"
                (mouseleave)="clearSuggestedMoveArrows()">{{rec.move}}</span>
          <span class="cct-empty" *ngIf="threatRecs.length < 1" [attr.title]="uiText.cct.noThreatsTitle">‚Äî</span>
        </ng-container>
      </div>
    </div>

  </section>
</div>





