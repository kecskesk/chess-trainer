<div class="trainer-layout">
  <div class="ambient-math" [ngClass]="getAmbientThemeClass()" [ngStyle]="ambientStyle" aria-hidden="true"></div>
  <section class="board-panel">
    <div class="outer-container board-shell" [class.board-shell--flipped]="isBoardFlipped">
      <div class="container" #chessField>
        <div #row class="field-row" *ngFor="let rowX of globalVariablesService.field; index as idxX">
          <div class="field-cell" *ngFor="let cellY of rowX; index as idxY">
            <div class="piece-box">
              <div class="square"
                   cdkDropList
                   cdkDropListOrientation="horizontal"
                    [cdkDropListEnterPredicate]="canDropPredicate"
                   id="field{{idxX}}{{idxY}}"
                   [ngClass]="getSquareHighlightClass(idxX, idxY)"
                   [cdkDropListData]="cellY"
                   [cdkDropListConnectedTo]="dropLists"
                   (cdkDropListEntered)="onDropListEntered($event)"
                   (cdkDropListDropped)="onDrop($event)"
                   [class.white-square]="(idxY + idxX) % 2 === 0"
                   [class.black-square]="(idxY + idxX) % 2 === 1">
                <div class="drag-box" cdkDrag
                   (cdkDragStarted)="onDragStarted()"
                   (cdkDragEnded)="onDragEnded()"
                   [cdkDragDisabled]="globalVariablesService.boardHelper.gameOver || !cellY || !cellY[0] || cellY[0].color !== globalVariablesService.boardHelper.colorTurn">
                  <app-chess-piece [piece]="cellY[0]" *ngIf="cellY && cellY[0]" cdkDragHandle></app-chess-piece>
                </div>
                <div class="notation">{{translateFieldNames(idxX, idxY)}}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="arrowPointer" *ngFor="let arrow of globalVariablesService.arrows; index as arrowIdx"
           [style.top]="arrow.top" [style.left]="arrow.left" [style.color]="arrow.color"
           [style.width]="arrow.length"
           [style.--arrow-thickness]="arrow.thickness"
           [style.transform]="'translate(-50%, -50%) rotate(' + arrow.rotate + ')'">
        <span class="arrow-shaft"></span>
        <span class="arrow-head"></span>
      </div>
    </div>
  </section>

  <section class="sidebar-panel">
    <div class="clock-card">
      <h3 class="section-title">Clock</h3>
      <div class="clock-stack">
        <div class="clock-display"
             [class.clock-display--active]="isClockActive(chessColors.Black)"
             [class.clock-display--low]="isClockLow(chessColors.Black)">
          <div class="clock-meta">
            <span class="clock-player">Black</span>
            <span class="clock-status" [class.clock-status--running]="isClockActive(chessColors.Black)"></span>
          </div>
          <span class="clock-time">{{formatClock(blackClockMs)}}</span>
        </div>
        <div class="clock-display"
             [class.clock-display--active]="isClockActive(chessColors.White)"
             [class.clock-display--low]="isClockLow(chessColors.White)">
          <div class="clock-meta">
            <span class="clock-player">White</span>
            <span class="clock-status" [class.clock-status--running]="isClockActive(chessColors.White)"></span>
          </div>
          <span class="clock-time">{{formatClock(whiteClockMs)}}</span>
        </div>
      </div>

      <div class="time-control-grid">
        <button class="time-btn"
                *ngFor="let preset of clockPresets"
                [class.time-btn--selected]="preset.label === selectedClockPresetLabel"
                (click)="applyTimeControl(preset.baseMinutes, preset.incrementSeconds, preset.label)">
          {{preset.label}}
        </button>
      </div>

      <div class="time-action-grid">
        <button class="action-btn action-btn--large" (click)="startOrPauseClock()">{{getClockButtonLabel()}}</button>
        <button class="action-btn action-btn--secondary action-btn--large" (click)="resetClock()">Reset Clock</button>
      </div>
    </div>

    <div class="status-card">
      <h3 class="section-title">
        {{getStatusTitle()}}
      </h3>
      <div class="actions-row">
        <button class="action-btn" (click)="showPossibleMoves(globalVariablesService.boardHelper.colorTurn)">show possible moves</button>
        <button class="action-btn action-btn--secondary" (click)="showPossibleMoves(null)">clear</button>
        <button class="action-btn" *ngIf="canOfferDraw()" (click)="offerDraw()">offer draw</button>
        <button class="action-btn" *ngIf="canRespondToDrawOffer()" (click)="acceptDrawOffer()">accept draw</button>
        <button class="action-btn action-btn--secondary" *ngIf="canRespondToDrawOffer()" (click)="declineDrawOffer()">decline draw</button>
        <button class="action-btn action-btn--secondary" *ngIf="canClaimDraw()" (click)="claimDraw()">claim draw</button>
      </div>
      <div class="icon-actions-row icon-actions-row--resign">
        <button class="icon-action-btn icon-action-btn--danger"
                [disabled]="!canResign(chessColors.White)"
                (click)="openResignConfirm(chessColors.White)"
                title="White resign"
                aria-label="White resign">
          <span class="icon-action-btn__icon">â™”</span>
          <span class="icon-action-btn__text">White</span>
        </button>
        <button class="icon-action-btn icon-action-btn--danger"
                [disabled]="!canResign(chessColors.Black)"
                (click)="openResignConfirm(chessColors.Black)"
                title="Black resign"
                aria-label="Black resign">
          <span class="icon-action-btn__icon">â™š</span>
          <span class="icon-action-btn__text">Black</span>
        </button>
      </div>
      <div class="mini-modal" *ngIf="resignConfirmColor !== null" role="dialog" aria-modal="false" aria-label="Confirm resignation">
        <div class="mini-modal__text">
          Are you sure {{resignConfirmColor === chessColors.White ? 'White' : 'Black'}} resigns?
        </div>
        <div class="mini-modal__actions">
          <button class="action-btn action-btn--secondary" (click)="cancelResignConfirm()">Cancel</button>
          <button class="action-btn action-btn--danger" (click)="confirmResign()">Resign</button>
        </div>
      </div>
    </div>

    <div class="tool-card" *ngIf="globalVariablesService.boardHelper.canPromote !== null">
      <h3 class="section-title">Promote</h3>
      <div class="actions-grid actions-grid--compact">
        <button class="action-btn" (click)="promotePiece('rook')">Rook</button>
        <button class="action-btn" (click)="promotePiece('bishop')">Bishop</button>
        <button class="action-btn" (click)="promotePiece('knight')">Knight</button>
        <button class="action-btn" (click)="promotePiece('queen')">Queen</button>
      </div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Magic Toolkit</h3>
      <div class="icon-actions-row">
        <button class="icon-action-btn" (click)="showThreats()" title="My threats" aria-label="My threats">
          <span class="icon-action-btn__icon">âš”</span>
          <span class="icon-action-btn__text">Mine</span>
        </button>
        <button class="icon-action-btn" (click)="showProtected()" title="My protected" aria-label="My protected">
          <span class="icon-action-btn__icon">ðŸ›¡</span>
          <span class="icon-action-btn__text">Safe</span>
        </button>
        <button class="icon-action-btn" (click)="showThreats(true)" title="Enemy threats" aria-label="Enemy threats">
          <span class="icon-action-btn__icon">â˜ </span>
          <span class="icon-action-btn__text">Enemy</span>
        </button>
        <button class="icon-action-btn" (click)="showProtected(true)" title="Enemy protected" aria-label="Enemy protected">
          <span class="icon-action-btn__icon">â›¨</span>
          <span class="icon-action-btn__text">Guarded</span>
        </button>
      </div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Magicer Toolkit</h3>
      <div class="icon-actions-row icon-actions-row--compact">
        <button class="icon-action-btn" (click)="showHangingPieces()" title="My hanging pieces (blundered)" aria-label="My hanging pieces">
          <span class="icon-action-btn__icon">âš </span>
          <span class="icon-action-btn__text">Blunder</span>
        </button>
        <button class="icon-action-btn" (click)="showHangingPieces(true)" title="Hanging enemy pieces (hittable)" aria-label="Hanging enemy pieces">
          <span class="icon-action-btn__icon">ðŸŽ¯</span>
          <span class="icon-action-btn__text">Target</span>
        </button>
      </div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Game Tools</h3>
      <div class="icon-actions-row icon-actions-row--compact">
        <button class="icon-action-btn" (click)="toggleBoardFlip()" title="Flip board" aria-label="Flip board">
          <span class="icon-action-btn__icon">â‡…</span>
          <span class="icon-action-btn__text">{{isBoardFlipped ? 'Normal' : 'Flip'}}</span>
        </button>
        <button class="icon-action-btn" (click)="exportPgnMock()" title="Export PGN (mock)" aria-label="Export PGN">
          <span class="icon-action-btn__icon">â­³</span>
          <span class="icon-action-btn__text">PGN</span>
        </button>
        <button class="icon-action-btn" (click)="exportBoardImageMock()" title="Export image (mock)" aria-label="Export board image">
          <span class="icon-action-btn__icon">ðŸ–¼</span>
          <span class="icon-action-btn__text">Image</span>
        </button>
      </div>
      <div class="mock-export-text" *ngIf="mockExportMessage">{{mockExportMessage}}</div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Recognition</h3>
      <div class="recognition-line"><strong>Opening:</strong> {{getMockOpeningRecognition()}}</div>
      <div class="recognition-line"><strong>Endgame:</strong> {{getMockEndgameRecognition()}}</div>
    </div>

    <div class="history-card">
      <h3 class="section-title">History</h3>
      <div class="icon-actions-row icon-actions-row--compact history-controls">
        <button class="icon-action-btn" [disabled]="!canUndoMoveMock()" (click)="undoMoveMock()" title="Undo move (mock)" aria-label="Undo move">
          <span class="icon-action-btn__icon">â†¶</span>
          <span class="icon-action-btn__text">Undo</span>
        </button>
        <button class="icon-action-btn" [disabled]="!canRedoMoveMock()" (click)="redoMoveMock()" title="Redo move (mock)" aria-label="Redo move">
          <span class="icon-action-btn__icon">â†·</span>
          <span class="icon-action-btn__text">Redo</span>
        </button>
      </div>
      <div class="history-log">
        <div class="history-entry" *ngFor="let histItem of getVisibleHistory(); index as histIdx">
          <span class="history-move">
            <span *ngIf="histIdx % 2 === 0">{{(histIdx / 2) + 1}}. </span>
            {{histItem}}
          </span>
          <span class="history-eval">SF {{getMockEvaluationForMove(histIdx)}}</span>
        </div>
      </div>
    </div>

    <div class="debug-card" *ngIf="globalVariablesService.boardHelper">
      <div *ngIf="globalVariablesService.boardHelper.debugText">{{globalVariablesService.boardHelper.debugText}}</div>
      <div>Position key: {{getDebugPositionKey()}}</div>
    </div>
  </section>
</div>
