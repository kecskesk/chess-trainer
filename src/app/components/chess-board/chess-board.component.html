<div class="trainer-layout">
  <div class="ambient-math" [ngClass]="getAmbientThemeClass()" [ngStyle]="ambientStyle" aria-hidden="true"></div>
  <section class="board-panel">
    <div class="outer-container board-shell">
      <div class="container" #chessField>
        <div #row class="field-row" *ngFor="let rowX of globalVariablesService.field; index as idxX">
          <div class="field-cell" *ngFor="let cellY of rowX; index as idxY">
            <div class="piece-box">
              <div class="square"
                   cdkDropList
                   cdkDropListOrientation="horizontal"
                    [cdkDropListEnterPredicate]="canDropPredicate"
                   id="field{{idxX}}{{idxY}}"
                   [ngClass]="getSquareHighlightClass(idxX, idxY)"
                   [cdkDropListData]="cellY"
                   [cdkDropListConnectedTo]="dropLists"
                   (cdkDropListEntered)="onDropListEntered($event)"
                   (cdkDropListDropped)="onDrop($event)"
                   [class.white-square]="(idxY + idxX) % 2 === 0"
                   [class.black-square]="(idxY + idxX) % 2 === 1">
                <div class="drag-box" cdkDrag
                   (cdkDragStarted)="onDragStarted()"
                   (cdkDragEnded)="onDragEnded()"
                   [cdkDragDisabled]="globalVariablesService.boardHelper.gameOver || !cellY || !cellY[0] || cellY[0].color !== globalVariablesService.boardHelper.colorTurn">
                  <app-chess-piece [piece]="cellY[0]" *ngIf="cellY && cellY[0]" cdkDragHandle></app-chess-piece>
                </div>
                <div class="notation">{{translateFieldNames(idxX, idxY)}}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="arrowPointer" *ngFor="let arrow of globalVariablesService.arrows; index as arrowIdx"
           [style.top]="arrow.top" [style.left]="arrow.left" [style.color]="arrow.color"
           [style.width]="arrow.length"
           [style.--arrow-thickness]="arrow.thickness"
           [style.transform]="'translate(-50%, -50%) rotate(' + arrow.rotate + ')'">
        <span class="arrow-shaft"></span>
        <span class="arrow-head"></span>
      </div>
    </div>
  </section>

  <section class="sidebar-panel">
    <div class="clock-card">
      <h3 class="section-title">Clock</h3>
      <div class="clock-stack">
        <div class="clock-display"
             [class.clock-display--active]="isClockActive(chessColors.Black)"
             [class.clock-display--low]="isClockLow(chessColors.Black)">
          <span class="clock-player">Black</span>
          <span class="clock-time">{{formatClock(blackClockMs)}}</span>
        </div>
        <div class="clock-display"
             [class.clock-display--active]="isClockActive(chessColors.White)"
             [class.clock-display--low]="isClockLow(chessColors.White)">
          <span class="clock-player">White</span>
          <span class="clock-time">{{formatClock(whiteClockMs)}}</span>
        </div>
      </div>

      <div class="time-control-grid">
        <button class="time-btn"
                *ngFor="let preset of clockPresets"
                [class.time-btn--selected]="preset.label === selectedClockPresetLabel"
                (click)="applyTimeControl(preset.baseMinutes, preset.incrementSeconds, preset.label)">
          {{preset.label}}
        </button>
      </div>

      <div class="time-action-grid">
        <button class="action-btn action-btn--large" (click)="startOrPauseClock()">{{getClockButtonLabel()}}</button>
        <button class="action-btn action-btn--secondary action-btn--large" (click)="resetClock()">Reset Clock</button>
      </div>
    </div>

    <div class="status-card">
      <h3 class="section-title">
        {{getStatusTitle()}}
      </h3>
      <div class="actions-row">
        <button class="action-btn" (click)="showPossibleMoves(globalVariablesService.boardHelper.colorTurn)">show possible moves</button>
        <button class="action-btn action-btn--secondary" (click)="showPossibleMoves(null)">clear</button>
        <button class="action-btn" *ngIf="canOfferDraw()" (click)="offerDraw()">offer draw</button>
        <button class="action-btn" *ngIf="canRespondToDrawOffer()" (click)="acceptDrawOffer()">accept draw</button>
        <button class="action-btn action-btn--secondary" *ngIf="canRespondToDrawOffer()" (click)="declineDrawOffer()">decline draw</button>
        <button class="action-btn action-btn--secondary" *ngIf="canClaimDraw()" (click)="claimDraw()">claim draw</button>
      </div>
      <div class="resign-grid">
        <button class="action-btn action-btn--danger action-btn--large"
                [disabled]="!canResign(chessColors.White)"
                (click)="resign(chessColors.White)">White resigns</button>
        <button class="action-btn action-btn--danger action-btn--large"
                [disabled]="!canResign(chessColors.Black)"
                (click)="resign(chessColors.Black)">Black resigns</button>
      </div>
    </div>

    <div class="tool-card" *ngIf="globalVariablesService.boardHelper.canPromote !== null">
      <h3 class="section-title">Promote</h3>
      <div class="actions-grid actions-grid--compact">
        <button class="action-btn" (click)="promotePiece('rook')">Rook</button>
        <button class="action-btn" (click)="promotePiece('bishop')">Bishop</button>
        <button class="action-btn" (click)="promotePiece('knight')">Knight</button>
        <button class="action-btn" (click)="promotePiece('queen')">Queen</button>
      </div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Magic Toolkit</h3>
      <div class="actions-grid">
        <button class="action-btn" (click)="showThreats()">my threats</button>
        <button class="action-btn" (click)="showProtected()">my protected</button>
        <button class="action-btn" (click)="showThreats(true)">threats from enemy</button>
        <button class="action-btn" (click)="showProtected(true)">protected enemy</button>
      </div>
    </div>

    <div class="tool-card">
      <h3 class="section-title">Magicer Toolkit</h3>
      <div class="actions-grid actions-grid--compact">
        <button class="action-btn" (click)="showHangingPieces()">my hanging piece (blundered)</button>
        <button class="action-btn" (click)="showHangingPieces(true)">hanging enemy (hittable)</button>
      </div>
    </div>

    <div class="history-card">
      <h3 class="section-title">History</h3>
      <div class="history-log">
        <span class="history-entry" *ngFor="let histItem of globalVariablesService.history; index as histIdx">
          <span *ngIf="histIdx % 2 === 0">{{(histIdx / 2) + 1}}. </span>
          {{histItem}}
          <br *ngIf="histIdx % 2 === 1" />
        </span>
      </div>
    </div>

    <div class="debug-card" *ngIf="globalVariablesService.boardHelper">
      <div *ngIf="globalVariablesService.boardHelper.debugText">{{globalVariablesService.boardHelper.debugText}}</div>
      <div>Position key: {{getDebugPositionKey()}}</div>
    </div>
  </section>
</div>
